## Notes for Splunk Threat Hunting

Started by opening the console from the web and logging in to the splunk as Admin

The task advises to run

```
index=* | stats count by index
```

```
index=* | stats count by sourcetype index
```

First task is to find the IP address of the internal host infected with Gh0st RAT malware

### Thought Process

The only actionable information provided in the scenario that can aid in starting the investigation is that there is a suspected Gh0st RAT malware infection.

Intrusion detection signatures for Gh0st RAT are widely available and enabled by default in most rule sets. Suricata IDS logs were provided as a source. Therefore, analyzing these logs is a logical place to begin the investigation. The network diragram shows the location of two sensors named `onion-fn1` and `onion-fn2`, which generate the Zeek and Suricata logs. These logs have been ingested in Splunk.

The advisory now makes sense. It's useful to understand how the log sources were ingested, and which indexes they are stored in.

We can query for logs from suricata and just search *gh0st*.

```
index=* sourcetype=suricata gh0st
```

And we get suricata alert logs indicating Gh0st RAT infection of an IP address 172.16.6.104 (HR Department according to the network diagram).

We can see if there are other infected hosts by adding a NOT operator and giving it the IP address we identified.

The first alert came in 6/22/23 10:14:57 indicating compromise

Another more effective way of determining the infected hosts goes like this.

Querying splunk indexes/sourcetypes:

```
index=* | stats count by index sourcetype
```

The query data shows the Suricata logs are stored in the index named `suricata`.

Looking at suricata logs:
```
index=suricata
```

The query shows thousands of logs entries. In order to more effectively analyze them, they need to be further reduced. The hosts field shows that there are two hosts that generated Suricata logs, `onion-fn1` and `onion-fn2`. The network diagram shows that `onion-fn1` monitors the network perimeter. Logs generated by `onion-fn1` are therefore most likely to help provide the IP address of the internal host.

The following Splunk query shows all Suricata logs generated by `onion-fn1`.

```
index=suricata host=onion-fn1
```

While filtering on events generated only by `onion-fn1` reduced the log count by more than half, it is still too many entries for manual analysis. A technique called stack counting, or long tail analysis, can be used to further reduce the log count by focusing on a single interesting field. In this case the field called `"alert.signature"` appears to provide a short description of what triggered the IDS alert. This field is a good candidate for stack counting.

The following Splunk query shows only the `alert.signature` fields generated by `onion-fn1`:

```
index=suricata host=onion-fn1| stats count by alert.signature
```

The filtered logs can be seearch for evidence of Gh0st RAT

Fields for source and destination IP can be added to the final query output.

The following Splunk query searches for alerts containing the string `Gh0st`, and extracts fields such as the timestamp, alert signature, source IP and destination IP:

```
index=suricata host=onion-fn1 Gh0st | stats count by alert.signature src_ip dest_ip
```

This reveals that the potentially infected host IP address is `172.16.6.104` which is communicating with the external IP address `199.28.139.120`

